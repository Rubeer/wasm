
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
</head>

<script type="module">

    async function init()
    {
        let MemoryPageCount = 32;
        let MemorySize = MemoryPageCount * 65536;

        let Imports = {};
        Imports['memory'] = new WebAssembly.Memory({'initial':MemoryPageCount});
        let Memory = new Uint8Array(Imports['memory']['buffer']);

        let utf8dec = new TextDecoder("utf-8");
        function GetWasmString(Length, Pointer)
        {
            let data = Memory.subarray(Pointer, Pointer+Length);
            return utf8dec.decode(data);
        }

        Imports['JSLog'] = function(StringLength, StringPtr)
        {
            console.log("main.wasm: " + GetWasmString(StringLength, StringPtr));
        }

        Imports['JSAbort'] = function(ReasonLength, ReasonPtr,
                                      FileNameLength, FileNamePtr,
                                      LineNumber)
        {
            let Reason = GetWasmString(ReasonLength, ReasonPtr);
            let FileName = GetWasmString(FileNameLength, FileNamePtr);
            let Message = "main.wasm: ABORT: (" + FileName + ":" + LineNumber + ") " + Reason;
            throw new Error(Message);
        }


        const { instance } = await WebAssembly.instantiateStreaming(
            fetch("main.wasm"),
            {"env":Imports}
        );

        instance.exports.Init(MemorySize);
    }
    init();
</script>

</html>
